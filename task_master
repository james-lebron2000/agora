#!/bin/bash
# task_master - ä»»åŠ¡ç®¡ç†CLIå·¥å…·

COMMAND=$1

usage() {
    echo "Task Master - è‡ªåŠ¨åŒ–é¡¹ç›®ä»»åŠ¡ç®¡ç†"
    echo ""
    echo "ç”¨æ³•:"
    echo "  ./task_master list                 æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡"
    echo "  ./task_master status               æŸ¥çœ‹å½“å‰çŠ¶æ€"
    echo "  ./task_master report               ç”Ÿæˆè¿›åº¦æŠ¥å‘Š"
    echo "  ./task_master add <project> <desc> æ·»åŠ æ–°ä»»åŠ¡"
    echo "  ./task_master install              å®‰è£…cronå®šæ—¶ä»»åŠ¡"
    echo "  ./task_master check                æ‰‹åŠ¨æ£€æŸ¥ä»»åŠ¡é˜Ÿåˆ—"
    echo ""
}

case $COMMAND in
    list)
        echo "ğŸ“‹ ä»»åŠ¡é˜Ÿåˆ—:"
        echo ""
        echo "å¾…åŠä»»åŠ¡:"
        ls ~/clawd/task_queue/pending/*.yaml 2>/dev/null | while read f; do
            PRIORITY=$(grep "priority:" "$f" 2>/dev/null | cut -d: -f2 | xargs || echo "P2")
            DESC=$(grep "description:" "$f" 2>/dev/null | cut -d: -f2- | xargs || echo "No description")
            echo "  [${PRIORITY}] ${DESC:0:50}"
        done
        
        echo ""
        echo "è¿›è¡Œä¸­ä»»åŠ¡:"
        ls ~/clawd/task_queue/in_progress/*.yaml 2>/dev/null | while read f; do
            echo "  â€¢ $(basename $f .yaml)"
        done || echo "  (æ— )"
        
        echo ""
        echo "ä»Šæ—¥å®Œæˆ: $(ls ~/clawd/task_queue/completed/*$(date +%Y%m%d)* 2>/dev/null | wc -l) ä¸ª"
        ;;
    
    status)
        echo "ğŸ“Š Task Master çŠ¶æ€"
        echo "=================="
        echo ""
        echo "å¾…åŠ: $(ls ~/clawd/task_queue/pending/ 2>/dev/null | wc -l) ä¸ª"
        echo "è¿›è¡Œä¸­: $(ls ~/clawd/task_queue/in_progress/ 2>/dev/null | wc -l) ä¸ª"
        echo "ä»Šæ—¥å®Œæˆ: $(ls ~/clawd/task_queue/completed/*$(date +%Y%m%d)* 2>/dev/null | wc -l) ä¸ª"
        echo ""
        echo "å®šæ—¶ä»»åŠ¡çŠ¶æ€:"
        crontab -l | grep -q "task_master" && echo "  âœ… Cron å·²å®‰è£…" || echo "  âŒ Cron æœªå®‰è£…"
        ;;
    
    report)
        ./task_master_report.sh
        ;;
    
    add)
        PROJECT=$2
        DESC=$3
        
        if [ -z "$PROJECT" ] || [ -z "$DESC" ]; then
            echo "ç”¨æ³•: ./task_master add <project> <description>"
            exit 1
        fi
        
        TASK_FILE="~/clawd/task_queue/pending/task_$(date +%Y%m%d_%H%M%S).yaml"
        
        cat > $TASK_FILE << EOF
project: ${PROJECT}
type: FEATURE
priority: P2
description: ${DESC}
details: |
  ç”¨æˆ·æ·»åŠ çš„ä»»åŠ¡
  æ·»åŠ æ—¶é—´: $(date '+%Y-%m-%d %H:%M')
estimated_time: 1 hour
dependencies: []
EOF
        
        echo "âœ… ä»»åŠ¡å·²æ·»åŠ : $DESC"
        ;;
    
    install)
        ./install_cron.sh
        ;;
    
    check)
        ./task_master_check.sh
        ;;
    
    *)
        usage
        ;;
esac
